# Helmの--atomicオプション

## 概要

`--atomic`は、Helmのインストール、アップグレード、ロールバックコマンドで使用できるオプションです。このオプションを指定すると、デプロイメントが失敗した場合に自動的にロールバックが実行されます。

## 動作原理

`--atomic`オプションを使用すると：

1. **トランザクション的な動作**: デプロイメント全体が成功するか、完全に失敗するかのどちらかになります
2. **自動ロールバック**: リリースが失敗した場合、Helmは自動的に前の安定したバージョンにロールバックします
3. **待機とタイムアウト**: デプロイメントが完了するまで待機し、タイムアウトに達すると失敗と判断します

## 使用例

### インストール時
```bash
helm install myrelease ./mychart --atomic
```

### アップグレード時
```bash
helm upgrade myrelease ./mychart --atomic
```

### タイムアウトの指定
```bash
helm install myrelease ./mychart --atomic --timeout 5m
```

## メリット

1. **安全性の向上**: 部分的に失敗した状態でアプリケーションが残ることを防ぎます
2. **自動化との相性**: CI/CDパイプラインで人間の介入なしに安全にデプロイできます
3. **ダウンタイムの最小化**: 失敗時に素早く前の状態に戻ります

## 注意点

1. **パフォーマンス**: ロールバック処理が発生する可能性があるため、通常のデプロイより時間がかかることがあります
2. **リソース使用**: ロールバック用のバックアップが保持されるため、一時的により多くのリソースを使用します
3. **デバッグの難しさ**: 自動的にロールバックされるため、問題の原因を調査する時間が限られます

## 関連オプション

- `--wait`: リリースが成功するまで待機しますが、失敗時の自動ロールバックは行いません
- `--timeout`: 待機時間の上限を設定します（デフォルト: 5分）
- `--cleanup-on-fail`: インストール失敗時にリリースを削除します（`--atomic`には含まれています）

## まとめ

`--atomic`オプションは、本番環境での安全なデプロイメントに欠かせない機能です。特に自動化されたデプロイメントプロセスにおいて、予期しない問題から素早く回復できる保険として機能します。