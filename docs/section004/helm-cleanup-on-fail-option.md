# Helmの--cleanup-on-failオプション

## 概要
`--cleanup-on-fail`は、Helmインストール時に使用できるオプションで、インストールが失敗した場合にリリースを自動的に削除します。

## 動作原理

1. **インストール専用**: このオプションは`helm install`コマンドでのみ使用可能です
2. **失敗時の削除**: インストールが失敗すると、部分的にデプロイされたリソースを含むリリース全体が削除されます
3. **クリーンな状態の維持**: 失敗したリリースがクラスター内に残らないため、名前の競合を防ぎます

## 使用例

### 基本的な使用
```bash
helm install myrelease ./mychart --cleanup-on-fail
```

### --waitと組み合わせて使用
```bash
helm install myrelease ./mychart --cleanup-on-fail --wait
```

### タイムアウトも指定
```bash
helm install myrelease ./mychart --cleanup-on-fail --wait --timeout 10m
```

## --atomicとの違い

| 特性 | --atomic | --cleanup-on-fail |
|------|----------|-------------------|
| 対象コマンド | install, upgrade | install のみ |
| 失敗時の動作 | ロールバック | 削除 |
| --waitの包含 | 自動的に含む | 別途指定が必要 |
| --cleanup-on-failの包含 | 自動的に含む | - |

## 使用シーン

### 開発環境
- 試行錯誤が多い環境で、失敗したリリースを手動で削除する手間を省きます
- 新しいチャートの開発時に、何度も同じリリース名でインストールを試行する場合

### CI/CDパイプライン
- 自動化されたテストで、失敗時にクリーンアップを自動化します
- テスト環境での一時的なデプロイメントに最適

### 名前空間の管理
- 同じリリース名で何度も試行する場合に便利です
- リリース名の競合を防ぎ、クリーンな状態を保ちます

## 注意事項

1. **データの喪失**: 
   - PersistentVolumeClaimなども削除される可能性があります
   - 重要なデータがある場合は使用を避けるべきです

2. **デバッグの困難さ**: 
   - 失敗したリリースが削除されるため、問題の原因調査が難しくなります
   - デバッグ時は`--debug`フラグと併用することを推奨します

3. **アップグレードでは使用不可**: 
   - このオプションは新規インストール時のみ有効です
   - アップグレード時は`--atomic`を使用してください

## ベストプラクティス

1. **開発環境での使用**:
   ```bash
   helm install myapp ./chart --cleanup-on-fail --wait --debug
   ```

2. **本番環境では慎重に**:
   - 本番環境では`--atomic`の使用を検討してください
   - データの永続性が重要な場合は使用を避けます

3. **エラーログの保存**:
   ```bash
   helm install myapp ./chart --cleanup-on-fail --debug 2>&1 | tee install.log
   ```

## まとめ

`--cleanup-on-fail`は、開発やテスト環境において失敗したインストールの後処理を自動化する便利なオプションです。しかし、データの喪失やデバッグの困難さなどのリスクもあるため、使用する環境と目的を慎重に検討する必要があります。